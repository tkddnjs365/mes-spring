<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.mes.mes_boot.system.auth.SuperUser.mapper.SuperUserMapper">
    <select id="superUserLogin" resultType="com.mes.mes_boot.system.auth.SuperUser.dto.login.SuperUserDto">
        SELECT id,
               userid,
               name,
               role,
               JSON_EXTRACT(permissions, '$') AS permissions
        FROM super_users
        WHERE user_id = #{userId}
          AND password = #{password}
    </select>

    <insert id="createCompany" parameterType="map">
        INSERT INTO companies (code, name, description, created_at, updated_at, is_active, type)
        SELECT #{code},
               #{name},
               #{description},
               NOW(),
               NOW(),
               1,
               'admin'
    </insert>

    <select id="getComapnyAdmin" resultType="com.mes.mes_boot.system.auth.SuperUser.dto.company.CompanyAdminDto">
        SELECT a.id          AS userIdx
             , a.company_idx AS companyIdx
             , a.user_id     AS userId
             , a.created_at  AS createdAt
             , b.code        AS companyCode
             , a.name        AS name
        FROM users a
                 JOIN companies b ON a.company_idx = b.id
        WHERE b.code = #{company_code}
    </select>

    <insert id="createCompanyAdmin" parameterType="map">
        INSERT INTO users (user_id, password, name, role, permissions, is_approved, created_at, updated_at, company_idx)
        SELECT #{userId},
               SHA2(#{password}, 256),
               #{name},
               'admin',
               '["all"]',
               TRUE,
               NOW(),
               NOW(),
               (SELECT id FROM companies WHERE CODE = #{companyCode});
    </insert>

    <delete id="deleteCompanyAdmin" parameterType="map">
        DELETE
        FROM users
        WHERE role = 'admin'
          AND id = #{adminId}
    </delete>
</mapper>